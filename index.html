<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ú©Ù†ØªØ±Ù„ Ù…Ø§ÛŒØ¹Ø§Øª - Ù†Ø³Ø®Ù‡ Supabase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Tahoma, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      margin-top: 0;
      text-align: center;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
    }
    button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
      font-size: 14px;
    }
    button.secondary { background: #757575; }
    button.danger { background: #d32f2f; }
    button:disabled { opacity: 0.5; cursor: default; }

    input[type="date"], input[type="time"], select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .summary-card {
      background: #ffffff;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 12px;
      font-family: Tahoma, monospace;
      font-size: 13px;
    }
    .summary-card pre {
      white-space: pre-wrap;
      margin: 0;
    }

    .layout {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-start;
    }
    .table-wrapper {
      flex: 1 1 100%;
      min-width: 280px;
      background: #ffffff;
      border-radius: 10px;
      padding: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      max-height: 60vh;
      overflow-y: auto;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 900px;
    }
    thead {
      position: sticky;
      top: 0;
      background: #eeeeee;
      z-index: 1;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 4px 6px;
      text-align: center;
    }
    th { font-weight: 600; }
    tr:nth-child(even) td { background: #fafafa; }
    tr.active-row td { outline: 2px solid #0288d1; }

    /* Ø±Ù†Ú¯ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ */
    .input-header, .input-col { background-color: #d2f4ff; }   /* ÙˆØ±ÙˆØ¯ÛŒ */
    .output-header, .output-col { background-color: #F8B4DC; } /* Ø®Ø±ÙˆØ¬ÛŒ */
    .notes-header, .notes-col { background-color: #ecffef; }   /* ØªÙˆØ¶ÛŒØ­Ø§Øª */

    .save-col button {
      width: 100%;
      padding: 4px 6px;
      font-size: 11px;
      border-radius: 4px;
      background: #00897b;
      color: #fff;
    }

    .chart-card {
      margin-top: 16px;
      background: #ffffff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .chart-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }

    /* Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ */
    .hidden { display: none; }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal {
      background: #ffffff;
      border-radius: 10px;
      padding: 16px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-size: 13px;
    }
    .modal h3 {
      margin-top: 0;
      margin-bottom: 8px;
      text-align: center;
    }
    .modal-datetime {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .modal-datetime span {
      font-size: 12px;
    }
    .modal-datetime button {
      font-size: 11px;
      padding: 4px 8px;
    }
    .modal-datetime-edit {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      justify-content: center;
    }
    .modal-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-bottom: 10px;
    }
    .modal-grid button {
      padding: 8px 6px;
      font-size: 11px;
      background: #eeeeee;
      color: #222;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    .modal.small {
      max-width: 360px;
    }
    .modal-field-body {
      margin: 10px 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .modal-field-body input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: Tahoma, sans-serif;
    }

    @media (max-width: 768px) {
      .layout { flex-direction: column; }
      .table-wrapper { max-height: 50vh; }
      .modal-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ú©Ù†ØªØ±Ù„ Ù…Ø§ÛŒØ¹Ø§Øª (Ù†Ø³Ø®Ù‡ Supabase)</h1>

    <div class="top-bar">
      <span>Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø±:</span>
      <span id="userIdLabel" style="font-weight:bold;">...</span>
      <button id="changeUserBtn" class="secondary">ØªØºÛŒÛŒØ± Ú©Ø¯</button>
    </div>

    <div class="top-bar">
      <!-- Ø¯Ú©Ù…Ù‡ Ø¨Ø§ onclick Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ùˆ Ø¯Ø³Ú©ØªØ§Ù¾ -->
      <button id="newRowBtn" onclick="openEntryModalFromButton()">Ø¬Ø¯ÛŒØ¯ Ú†ÛŒ Ø¯Ø§Ø±ÛŒ Ø¨Ú¯ÛŒ</button>
      <span>ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡:</span>
      <input type="date" id="reportDate" />
      <button id="refreshSummaryBtn" class="secondary">Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
    </div>

    <div class="summary-card">
      <pre id="summaryText">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</pre>
      <div id="hydrationMessage"
           style="margin-top:8px;font-size:13px;font-weight:bold;display:none;align-items:center;justify-content:space-between;gap:8px;">
        <span id="hydrationText"></span>
        <button id="closeHydrationBtn" class="secondary" style="padding:2px 6px;font-size:11px;">Ã—</button>
      </div>
    </div>

    <div class="layout">
      <div class="table-wrapper">
        <table id="entriesTable">
          <thead>
            <tr>
              <th>ØªØ§Ø±ÛŒØ®</th>
              <th>Ø³Ø§Ø¹Øª</th>
              <th class="input-header">ØªØ²Ø±ÛŒÙ‚ (cc)</th>
              <th>Ù†ÙˆØ¹ ØªØ²Ø±ÛŒÙ‚</th>
              <th class="input-header">Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ (cc)</th>
              <th class="output-header">Ù†ÙØ±Ùˆ Ø±Ø§Ø³Øª (cc)</th>
              <th class="output-header">Ù†ÙØ±Ùˆ Ú†Ù¾ (cc)</th>
              <th class="output-header">Ø§ÛŒÙ„ÙˆØ³ØªÙˆÙ…ÛŒ (cc)</th>
              <th class="output-header">Ú©Ù„Ø³ØªÙˆÙ…ÛŒ (cc)</th>
              <th class="output-header">Ø§Ø³ØªÙØ±Ø§Øº (cc)</th>
              <th class="notes-header">ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
              <th class="save-col">Save</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§ØµÙ„ÛŒ ÙˆØ±ÙˆØ¯ Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯ -->
    <div id="entryModalOverlay" class="modal-overlay hidden" style="display:none;">
      <div class="modal">
        <h3>Ø«Ø¨Øª Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯</h3>
        <div class="modal-datetime">
          <span>ØªØ§Ø±ÛŒØ®: <span id="modalDateText"></span></span>
          <span>Ø³Ø§Ø¹Øª: <span id="modalTimeText"></span></span>
          <button id="editDateTimeBtn" class="secondary" onclick="toggleDateTimeEditors()">
            ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª
          </button>
        </div>
        <div id="modalDateTimeEditors" class="modal-datetime-edit hidden">
          <input type="date" id="modalDateInput" />
          <input type="time" id="modalTimeInput" step="60" />
        </div>
        <div style="font-size:11px; margin-bottom:6px; text-align:center;">
          Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù…ÙˆØ±Ø¯ØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø²Ù†ÛŒØ¯ØŒ Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ ØªØ£ÛŒÛŒØ¯/Ú©Ù†Ø³Ù„ Ú©Ù†ÛŒØ¯.
        </div>
        <div class="modal-grid">
          <button type="button" data-field="infusion_volume">ØªØ²Ø±ÛŒÙ‚ (cc)</button>
          <button type="button" data-field="oral_intake">Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ (cc)</button>
          <button type="button" data-field="nephro_right">Ù†ÙØ±Ùˆ Ø±Ø§Ø³Øª (cc)</button>
          <button type="button" data-field="nephro_left">Ù†ÙØ±Ùˆ Ú†Ù¾ (cc)</button>
          <button type="button" data-field="ileostomy">Ø§ÛŒÙ„ÙˆØ³ØªÙˆÙ…ÛŒ (cc)</button>
          <button type="button" data-field="colostomy">Ú©Ù„Ø³ØªÙˆÙ…ÛŒ (cc)</button>
          <button type="button" data-field="vomiting">Ø§Ø³ØªÙØ±Ø§Øº (cc)</button>
          <button type="button" data-field="notes">ØªÙˆØ¶ÛŒØ­Ø§Øª</button>
        </div>
        <div class="modal-footer">
          <button id="entryModalSaveBtn">Ø°Ø®ÛŒØ±Ù‡</button>
          <button id="entryModalCancelBtn" class="secondary">Ú©Ù†Ø³Ù„</button>
        </div>
      </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒÚ© ÙÛŒÙ„Ø¯ -->
    <div id="fieldModalOverlay" class="modal-overlay hidden" style="display:none;">
      <div class="modal small">
        <h3 id="fieldModalTitle">ÙˆÛŒØ±Ø§ÛŒØ´</h3>
        <div class="modal-field-body">
          <input id="fieldModalInput" type="number" dir="ltr" />
        </div>
        <div class="modal-footer">
          <button id="fieldModalConfirmBtn">ØªØ£ÛŒÛŒØ¯</button>
          <button id="fieldModalCancelBtn" class="secondary">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
      </div>
    </div>

    <!-- Ù†Ù…ÙˆØ¯Ø§Ø± ØªØ±Ù†Ø¯ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ ØµÙØ­Ù‡ -->
    <div class="chart-card">
      <div class="chart-controls">
        <span>Ø¨Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ® Ù†Ù…ÙˆØ¯Ø§Ø±:</span>
        <label>Ø§Ø²
          <input type="date" id="chartFromDate" />
        </label>
        <label>ØªØ§
          <input type="date" id="chartToDate" />
        </label>
        <span>Ø³ØªÙˆÙ†:</span>
        <select id="chartMetric">
          <option value="infusion_volume">ØªØ²Ø±ÛŒÙ‚ (cc)</option>
          <option value="oral_intake">Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ (cc)</option>
          <option value="nephro_right">Ù†ÙØ±ÙˆØ³ØªÙˆÙ…ÛŒ Ø±Ø§Ø³Øª (cc)</option>
          <option value="nephro_left">Ù†ÙØ±ÙˆØ³ØªÙˆÙ…ÛŒ Ú†Ù¾ (cc)</option>
          <option value="ileostomy">Ø§ÛŒÙ„ÙˆØ³ØªÙˆÙ…ÛŒ (cc)</option>
          <option value="colostomy">Ú©Ù„Ø³ØªÙˆÙ…ÛŒ (cc)</option>
          <option value="vomiting">Ø§Ø³ØªÙØ±Ø§Øº (cc)</option>
        </select>
        <button id="drawChartBtn">Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø±</button>
      </div>
      <canvas id="trendChart" height="120"></canvas>
    </div>
  </div>

  <script>
    // === Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase ===
    const supabaseUrl = "https://mmlvqmptvjeldxvkycrx.supabase.co";
    const supabaseAnonKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tbHZxbXB0dmplbGR4dmt5Y3J4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTUwODUsImV4cCI6MjA3OTMzMTA4NX0.bU65ru6zNAryNQQgkxCAU2mA-zQiwZCuCkOIZek4HJo";

    const supa = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    const STORAGE_USER_KEY = "fluid_supabase_user_code_v1";
    let currentUserCode = null;
    let entries = [];
    let currentEditingId = null;
    let trendChartInstance = null;
    let draftEntry = null;
    let currentFieldKey = null;

    const fieldTitles = {
      infusion_volume: "ØªØ²Ø±ÛŒÙ‚ (cc)",
      oral_intake: "Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ (cc)",
      nephro_right: "Ù†ÙØ±Ùˆ Ø±Ø§Ø³Øª (cc)",
      nephro_left: "Ù†ÙØ±Ùˆ Ú†Ù¾ (cc)",
      ileostomy: "Ø§ÛŒÙ„ÙˆØ³ØªÙˆÙ…ÛŒ (cc)",
      colostomy: "Ú©Ù„Ø³ØªÙˆÙ…ÛŒ (cc)",
      vomiting: "Ø§Ø³ØªÙØ±Ø§Øº (cc)",
      notes: "ØªÙˆØ¶ÛŒØ­Ø§Øª",
      infusion_type: "Ù†ÙˆØ¹ ØªØ²Ø±ÛŒÙ‚"
    };

    const metricLabels = {
      infusion_volume: "ØªØ²Ø±ÛŒÙ‚ (cc)",
      oral_intake: "Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ (cc)",
      nephro_right: "Ù†ÙØ±ÙˆØ³ØªÙˆÙ…ÛŒ Ø±Ø§Ø³Øª (cc)",
      nephro_left: "Ù†ÙØ±ÙˆØ³ØªÙˆÙ…ÛŒ Ú†Ù¾ (cc)",
      ileostomy: "Ø§ÛŒÙ„ÙˆØ³ØªÙˆÙ…ÛŒ (cc)",
      colostomy: "Ú©Ù„Ø³ØªÙˆÙ…ÛŒ (cc)",
      vomiting: "Ø§Ø³ØªÙØ±Ø§Øº (cc)",
    };

    function formatDateInput(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatTime(d) {
      const h = String(d.getHours()).padStart(2, "0");
      const m = String(d.getMinutes()).padStart(2, "0");
      return `${h}:${m}`;
    }

    function deriveTimestamp(dateStr, timeStr) {
      if (!dateStr) return null;
      const [y, m, d] = dateStr.split("-").map(Number);
      if (!y || !m || !d) return null;
      let hh = 0, mm = 0;
      if (timeStr && timeStr.includes(":")) {
        [hh, mm] = timeStr.split(":").map(Number);
      }
      const dt = new Date(y, m - 1, d, hh || 0, mm || 0, 0, 0);
      return dt.getTime();
    }

    // --- Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø± ---
    function askUserCode() {
      let code = null;
      while (!code) {
        const input = prompt(
          "ÛŒÚ© Ú©Ø¯ Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯ØªØ§Ù† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: farnaz-1404). Ø§ÛŒÙ† Ú©Ø¯ Ø±Ø§ Ø±ÙˆÛŒ ØªÙ…Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ ÛŒÚ©Ø³Ø§Ù† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:",
          ""
        );
        if (input === null) {
          alert("Ø¨Ø¯ÙˆÙ† Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø±ØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…Ø´ØªØ±Ú© ÙˆØµÙ„ Ø´ÙˆØ¯.");
          continue;
        }
        const trimmed = input.trim();
        if (!trimmed) {
          alert("Ú©Ø¯ Ù†Ø¨Ø§ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.");
          continue;
        }
        code = trimmed;
      }
      return code;
    }

    function setUserCode(code) {
      currentUserCode = code;
      localStorage.setItem(STORAGE_USER_KEY, code);
      document.getElementById("userIdLabel").textContent = code;
    }

    function getOrInitUserCode() {
      let code = localStorage.getItem(STORAGE_USER_KEY);
      if (!code) code = askUserCode();
      setUserCode(code);
    }

    // --- Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Supabase ---
    async function loadEntriesFromServer() {
      if (!currentUserCode) return [];
      const { data, error } = await supa
        .from("entries")
        .select("*")
        .eq("user_code", currentUserCode)
        .order("timestamp", { ascending: true });

      if (error) {
        console.error(error);
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡ Ø§Ø² Supabase (Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯).");
        return [];
      }
      return data || [];
    }

    async function saveEntryToServer(entry) {
      if (!currentUserCode) {
        alert("Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø± ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
        return;
      }
      const { error } = await supa
        .from("entries")
        .upsert(entry, { onConflict: "id" });

      if (error) {
        console.error(error);
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø±ÙˆÛŒ Supabase.");
      }
    }

    // --- Ø¬Ø¯ÙˆÙ„ Ø§ØµÙ„ÛŒ ---
    function renderTable() {
      const tbody = document.querySelector("#entriesTable tbody");
      tbody.innerHTML = "";

      const sorted = [...entries].sort(
        (a, b) => (a.timestamp || 0) - (b.timestamp || 0)
      );
      for (const e of sorted) {
        const tr = document.createElement("tr");
        tr.dataset.id = String(e.id);

        function addCell(field, value) {
          const td = document.createElement("td");
          td.dataset.field = field;

          if (["infusion_volume", "oral_intake"].includes(field)) {
            td.classList.add("input-col");
          }
          if (
            ["nephro_right", "nephro_left", "ileostomy", "colostomy", "vomiting"]
              .includes(field)
          ) {
            td.classList.add("output-col");
          }
          if (field === "notes") {
            td.classList.add("notes-col");
          }
          if (field === "save") {
            td.classList.add("save-col");
            const btn = document.createElement("button");
            btn.textContent = "Save";
            td.appendChild(btn);
          } else {
            td.textContent =
              value !== null && value !== undefined && value !== ""
                ? value
                : "";
          }
          tr.appendChild(td);
        }

        addCell("date", e.date || "");
        addCell("time", e.time || "");
        addCell("infusion_volume", e.infusion_volume ?? "");
        addCell("infusion_type", e.infusion_type ?? "");
        addCell("oral_intake", e.oral_intake ?? "");
        addCell("nephro_right", e.nephro_right ?? "");
        addCell("nephro_left", e.nephro_left ?? "");
        addCell("ileostomy", e.ileostomy ?? "");
        addCell("colostomy", e.colostomy ?? "");
        addCell("vomiting", e.vomiting ?? "");
        addCell("notes", e.notes ?? "");
        addCell("save", "");

        tbody.appendChild(tr);
      }
      highlightActiveRow();
    }

    function highlightActiveRow() {
      const rows = document.querySelectorAll("#entriesTable tbody tr");
      rows.forEach((tr) => {
        const id = Number(tr.dataset.id);
        if (currentEditingId && id === currentEditingId) {
          tr.classList.add("active-row");
        } else {
          tr.classList.remove("active-row");
        }
      });
    }

    async function editField(entryId, field) {
      const entry = entries.find((e) => e.id === entryId);
      if (!entry) return;

      if (field === "date") {
        const val = prompt(
          "ØªØ§Ø±ÛŒØ® (ÙØ±Ù…Øª YYYY-MM-DDØŒ Ù…Ø«Ù„Ø§ 2025-11-22):",
          entry.date || ""
        );
        if (val === null) return;
        entry.date = val.trim();
      } else if (field === "time") {
        const val = prompt(
          "Ø³Ø§Ø¹Øª (ÙØ±Ù…Øª HH:MMØŒ Ù…Ø«Ù„Ø§ 14:30):",
          entry.time || ""
        );
        if (val === null) return;
        entry.time = val.trim();
      } else if (field === "infusion_type" || field === "notes") {
        const val = prompt(
          field === "infusion_type" ? "Ù†ÙˆØ¹ ØªØ²Ø±ÛŒÙ‚:" : "ØªÙˆØ¶ÛŒØ­Ø§Øª:",
          entry[field] || ""
        );
        if (val === null) return;
        entry[field] = val.trim() || null;
      } else if (
        ["infusion_volume", "oral_intake", "nephro_right", "nephro_left",
         "ileostomy", "colostomy", "vomiting"].includes(field)
      ) {
        const oldVal = entry[field] != null ? String(entry[field]) : "";
        const val = prompt("Ù…Ù‚Ø¯Ø§Ø± Ø¨Ù‡ cc (ÙÙ‚Ø· Ø¹Ø¯Ø¯ØŒ Ø®Ø§Ù„ÛŒ = Ø­Ø°Ù):", oldVal);
        if (val === null) return;
        const t = val.trim();
        if (t === "") {
          entry[field] = null;
        } else {
          const num = Number(t);
          if (Number.isNaN(num)) {
            alert("Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø¹Ø¯Ø¯ Ù†ÛŒØ³Øª.");
            return;
          }
          entry[field] = num;
        }
      } else {
        return;
      }

      const ts = deriveTimestamp(entry.date, entry.time);
      if (ts) entry.timestamp = ts;

      renderTable();
      updateSummaryForSelectedDate();
      checkHydrationStatus();
      await saveEntryToServer(entry);
    }

    // --- Ø®Ù„Ø§ØµÙ‡ Ø±ÙˆØ²Ø§Ù†Ù‡ ---
    function calculateSummaryForDate(dateStr) {
      const dayEntries = entries.filter((e) => e.date === dateStr);

      const sum = (field) =>
        dayEntries.reduce((acc, e) => acc + (Number(e[field]) || 0), 0);

      const res = {
        infusionTotal: sum("infusion_volume"),
        oralTotal: sum("oral_intake"),
        nephroRightTotal: sum("nephro_right"),
        nephroLeftTotal: sum("nephro_left"),
        ileostomyTotal: sum("ileostomy"),
        colostomyTotal: sum("colostomy"),
        vomitingTotal: sum("vomiting"),
      };
      res.inputTotal = res.infusionTotal + res.oralTotal;
      res.outputTotal =
        res.nephroRightTotal +
        res.nephroLeftTotal +
        res.ileostomyTotal +
        res.colostomyTotal +
        res.vomitingTotal;
      res.netBalance = res.inputTotal - res.outputTotal;
      return res;
    }

    function buildSummaryText(summary, dateStr) {
      return [
        `ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´: ${dateStr}`,
        "",
        "ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§:",
        `- ØªØ²Ø±ÛŒÙ‚: ${summary.infusionTotal} cc`,
        `- Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ: ${summary.oralTotal} cc`,
        `Ù…Ø¬Ù…ÙˆØ¹ ÙˆØ±ÙˆØ¯ÛŒ: ${summary.inputTotal} cc`,
        "",
        "Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§:",
        `- Ù†ÙØ±ÙˆØ³ØªÙˆÙ…ÛŒ Ø±Ø§Ø³Øª: ${summary.nephroRightTotal} cc`,
        `- Ù†ÙØ±ÙˆØ³ØªÙˆÙ…ÛŒ Ú†Ù¾: ${summary.nephroLeftTotal} cc`,
        `- Ø§ÛŒÙ„ÙˆØ³ØªÙˆÙ…ÛŒ: ${summary.ileostomyTotal} cc`,
        `- Ú©Ù„Ø³ØªÙˆÙ…ÛŒ: ${summary.colostomyTotal} cc`,
        `- Ø§Ø³ØªÙØ±Ø§Øº: ${summary.vomitingTotal} cc`,
        `Ù…Ø¬Ù…ÙˆØ¹ Ø®Ø±ÙˆØ¬ÛŒ: ${summary.outputTotal} cc`,
        "",
        `ØªØ±Ø§Ø² Ù…Ø§ÛŒØ¹ (ÙˆØ±ÙˆØ¯ÛŒ - Ø®Ø±ÙˆØ¬ÛŒ): ${summary.netBalance} cc`,
      ].join("\n");
    }

    function updateSummaryForSelectedDate() {
      const dateInput = document.getElementById("reportDate");
      const dateStr = dateInput.value;
      const summaryEl = document.getElementById("summaryText");
      if (!dateStr) {
        summaryEl.textContent = "Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.";
        return;
      }
      const summary = calculateSummaryForDate(dateStr);
      summaryEl.textContent = buildSummaryText(summary, dateStr);
    }

    // --- Ù¾ÛŒØ§Ù… ÙˆØ¶Ø¹ÛŒØª Ù…Ø§ÛŒØ¹Ø§Øª ---
    function checkHydrationStatus() {
      const box = document.getElementById("hydrationMessage");
      const textEl = document.getElementById("hydrationText");
      if (!box || !textEl) return;

      if (window._hydrationDismissed) {
        box.style.display = "none";
        return;
      }

      if (!entries || entries.length === 0) {
        box.style.display = "none";
        return;
      }

      const today = new Date();
      const todayStr = formatDateInput(today);
      const todaySummary = calculateSummaryForDate(todayStr);
      const todayNet = todaySummary.netBalance;

      const messages = [];

      if (todayNet < 0) {
        messages.push("Ø¨Ú†Ù‡ Ù…Ø§ÛŒØ¹Ø§Øª Ø¨Ø®ÙˆØ± ØŒ Ø¹Ù‚Ø¨ Ù‡Ø³ØªÛŒØ§! ğŸ¥¤");
      } else if (todayNet > 0) {
        messages.push("Ø¢ÙØ±ÛŒÛŒÛŒÛŒÛŒÙ† ğŸ‘ Ù…Ø§ÛŒØ¹Ø§Øª Ø¬Ù„Ùˆ Ù‡Ø³ØªÛŒ!");
      }

      let negativeDays = 0;
      for (let i = 1; i <= 3; i++) {
        const d = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
        const dStr = formatDateInput(d);
        const s = calculateSummaryForDate(dStr);
        if (s.netBalance < 0) negativeDays++;
      }

      if (negativeDays > 0) {
        messages.push(
          `ØªÙˆ Ø³Ù‡ Ø±ÙˆØ² Ù‚Ø¨Ù„ Ù…Ø§ÛŒØ¹Ø§Øª Ø¹Ù‚Ø¨ Ø¨ÙˆØ¯ÛŒØ§ ğŸ˜¬ (Ø¯Ø± ${negativeDays} Ø±ÙˆØ² Ø§Ø² Û³ Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡ ØªØ±Ø§Ø² Ù…Ù†ÙÛŒ Ø¨ÙˆØ¯Ù‡)`
        );
      }

      if (messages.length === 0) {
        box.style.display = "none";
      } else {
        textEl.textContent = messages.join("  |  ");
        box.style.display = "flex";
      }
    }

    // --- Ù†Ù…ÙˆØ¯Ø§Ø± ØªØ±Ù†Ø¯ ---
    async function drawTrendChart() {
      if (!currentUserCode) {
        alert("Ø§ÙˆÙ„ Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.");
        return;
      }
      const fromDate = document.getElementById("chartFromDate").value;
      const toDate = document.getElementById("chartToDate").value;
      const metric = document.getElementById("chartMetric").value;

      if (!fromDate || !toDate) {
        alert("Ù„Ø·ÙØ§Ù‹ Ù‡Ø± Ø¯Ùˆ ØªØ§Ø±ÛŒØ® Â«Ø§Ø²Â» Ùˆ Â«ØªØ§Â» Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
        return;
      }
      if (fromDate > toDate) {
        alert("ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø´Ø¯.");
        return;
      }

      entries = await loadEntriesFromServer();

      const filtered = entries.filter(
        (e) => e.date && e.date >= fromDate && e.date <= toDate
      );

      if (filtered.length === 0) {
        alert("Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡â€ŒÛŒ Ø²Ù…Ø§Ù†ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
        return;
      }

      const map = new Map(); // date -> sum
      for (const e of filtered) {
        const d = e.date;
        const v = Number(e[metric]) || 0;
        map.set(d, (map.get(d) || 0) + v);
      }

      const dates = Array.from(map.keys()).sort();
      const data = dates.map((d) => map.get(d));

      const ctx = document.getElementById("trendChart").getContext("2d");
      if (trendChartInstance) trendChartInstance.destroy();

      trendChartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: dates,
          datasets: [
            {
              label: metricLabels[metric] || metric,
              data: data,
              tension: 0.3,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: (context) => `${context.parsed.y} cc`,
              },
            },
          },
          scales: {
            x: { title: { display: true, text: "ØªØ§Ø±ÛŒØ®" } },
            y: {
              title: { display: true, text: "Ù…Ù‚Ø¯Ø§Ø± (cc)" },
              beginAtZero: true,
            },
          },
        },
      });
    }

    // --- Ù…ÙˆØ¯Ø§Ù„ Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯ ---
    const entryModal = document.getElementById("entryModalOverlay");
    const modalDateText = document.getElementById("modalDateText");
    const modalTimeText = document.getElementById("modalTimeText");
    const modalDateInput = document.getElementById("modalDateInput");
    const modalTimeInput = document.getElementById("modalTimeInput");

    function refreshModalFieldButtons() {
      document
        .querySelectorAll("#entryModalOverlay .modal-grid button")
        .forEach((btn) => {
          const field = btn.getAttribute("data-field");
          const base = fieldTitles[field] || field;
          const v = draftEntry ? draftEntry[field] : null;
          btn.textContent =
            v !== null && v !== undefined && v !== "" ? `${base} : ${v}` : base;
        });
    }

    function openEntryModal() {
      if (!currentUserCode) {
        alert("Ø§ÙˆÙ„ Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.");
        return;
      }
      const now = new Date();
      const dateStr = formatDateInput(now);
      const timeStr = formatTime(now);

      draftEntry = {
        id: Date.now(),
        user_code: currentUserCode,
        timestamp: now.getTime(),
        date: dateStr,
        time: timeStr,
        infusion_volume: null,
        infusion_type: null,
        oral_intake: null,
        nephro_right: null,
        nephro_left: null,
        ileostomy: null,
        colostomy: null,
        vomiting: null,
        notes: null,
      };

      modalDateText.textContent = draftEntry.date;
      modalTimeText.textContent = draftEntry.time;
      modalDateInput.value = draftEntry.date;
      modalTimeInput.value = draftEntry.time;
      document.getElementById("modalDateTimeEditors").classList.add("hidden");

      refreshModalFieldButtons();
      entryModal.classList.remove("hidden");
      entryModal.style.display = "flex";
    }

    // Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ HTML Ø±ÙˆÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„/Ø¯Ø³Ú©ØªØ§Ù¾
    function openEntryModalFromButton() {
      try {
        openEntryModal();
      } catch (e) {
        console.error("Error in openEntryModalFromButton:", e);
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ù†Ø¬Ø±Ù‡ Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯. ÛŒÚ© Ø¨Ø§Ø± Ø±ÙØ±Ø´ Ú©Ù† Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.");
      }
    }

    function closeEntryModal(discard) {
      if (discard) draftEntry = null;
      entryModal.classList.add("hidden");
      entryModal.style.display = "none";
    }

    // --- Ø¨Ø§Ø² Ùˆ Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø¯ÛŒØª ØªØ§Ø±ÛŒØ®/Ø³Ø§Ø¹Øª (global Ø¨Ø±Ø§ÛŒ onclick) ---
    function toggleDateTimeEditors() {
      const box = document.getElementById("modalDateTimeEditors");
      if (!box) return;
      box.classList.toggle("hidden");
    }

    // --- Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ ÙÛŒÙ„Ø¯ ---
    const fieldModalOverlay = document.getElementById("fieldModalOverlay");
    const fieldModalTitle = document.getElementById("fieldModalTitle");
    const fieldModalInput = document.getElementById("fieldModalInput");

    function openFieldModal(fieldKey) {
      if (!draftEntry) return;
      currentFieldKey = fieldKey;

      fieldModalTitle.textContent = fieldTitles[fieldKey] || "ÙˆÛŒØ±Ø§ÛŒØ´";

      if (fieldKey === "notes" || fieldKey === "infusion_type") {
        fieldModalInput.type = "text";
        fieldModalInput.dir = "rtl";
      } else {
        fieldModalInput.type = "number";
        fieldModalInput.dir = "ltr";
      }

      const curVal = draftEntry[fieldKey];
      fieldModalInput.value =
        curVal !== null && curVal !== undefined ? curVal : "";
      fieldModalOverlay.classList.remove("hidden");
      fieldModalOverlay.style.display = "flex";
      fieldModalInput.focus();
    }

    function closeFieldModal() {
      fieldModalOverlay.classList.add("hidden");
      fieldModalOverlay.style.display = "none";
      currentFieldKey = null;
    }

    function applyFieldModalConfirm() {
      if (!draftEntry || !currentFieldKey) {
        closeFieldModal();
        return;
      }
      const val = fieldModalInput.value.trim();

      if (currentFieldKey === "notes" || currentFieldKey === "infusion_type") {
        draftEntry[currentFieldKey] = val || null;
      } else {
        if (val === "") {
          draftEntry[currentFieldKey] = null;
        } else {
          const num = Number(val);
          if (Number.isNaN(num)) {
            alert("Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ø¹Ø¯Ø¯ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
            return;
          }
          draftEntry[currentFieldKey] = num;
        }
      }

      refreshModalFieldButtons();
      const justField = currentFieldKey;
      closeFieldModal();

      if (justField === "infusion_volume" && draftEntry.infusion_volume != null) {
        openFieldModal("infusion_type");
      }
    }

    function applyFieldModalCancel() {
      closeFieldModal();
      try {
        if (draftEntry && currentFieldKey) {
          draftEntry[currentFieldKey] = null;
        }
        refreshModalFieldButtons();
      } catch (err) {
        console.error("Modal cancel error:", err);
      }
    }

    async function saveDraftEntry() {
      if (!draftEntry) return;

      if (modalDateInput.value) draftEntry.date = modalDateInput.value;
      if (modalTimeInput.value) draftEntry.time = modalTimeInput.value;

      const ts = deriveTimestamp(draftEntry.date, draftEntry.time);
      draftEntry.timestamp = ts || Date.now();

      entries.push(draftEntry);
      await saveEntryToServer(draftEntry);
      renderTable();
      updateSummaryForSelectedDate();
      checkHydrationStatus();

      draftEntry = null;
      closeEntryModal(false);
    }

    // --- init ---
    async function initApp() {
      // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¨Ø³ØªÙ‡ Ø¨ÙˆØ¯Ù† Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹
      entryModal.classList.add("hidden");
      entryModal.style.display = "none";
      fieldModalOverlay.classList.add("hidden");
      fieldModalOverlay.style.display = "none";
      draftEntry = null;
      currentFieldKey = null;

      const today = new Date();
      const todayStr = formatDateInput(today);
      const reportDateInput = document.getElementById("reportDate");
      reportDateInput.value = todayStr;

      const chartFromInput = document.getElementById("chartFromDate");
      const chartToInput = document.getElementById("chartToDate");
      const weekAgo = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000);
      chartToInput.value = todayStr;
      chartFromInput.value = formatDateInput(weekAgo);

      getOrInitUserCode();

      entries = await loadEntriesFromServer();
      renderTable();
      updateSummaryForSelectedDate();
      checkHydrationStatus();
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ø¯Ø± Ù„ÙˆØ¯ Ø§ÙˆÙ„ÛŒÙ‡ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ Ø¨Ø³ØªÙ‡â€ŒØ§Ù†Ø¯
      entryModal.classList.add("hidden");
      entryModal.style.display = "none";
      fieldModalOverlay.classList.add("hidden");
      fieldModalOverlay.style.display = "none";

      document.getElementById("refreshSummaryBtn").addEventListener("click", async () => {
        entries = await loadEntriesFromServer();
        renderTable();
        updateSummaryForSelectedDate();
        checkHydrationStatus();
      });

      document.getElementById("drawChartBtn").addEventListener("click", () => {
        drawTrendChart().catch(console.error);
      });

      // Ø¬Ø¯ÙˆÙ„ â€“ Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Save
      const tbody = document.querySelector("#entriesTable tbody");
      tbody.addEventListener("click", (e) => {
        const td = e.target.closest("td");
        if (!td) return;
        const tr = td.parentElement;
        const id = Number(tr.dataset.id);
        if (!id) return;

        const field = td.dataset.field;

        if (field === "save") {
          currentEditingId = null;
          highlightActiveRow();
          return;
        }

        currentEditingId = id;
        highlightActiveRow();
        if (field) {
          editField(id, field);
        }
      });

      document.getElementById("changeUserBtn").addEventListener("click", async () => {
        const input = prompt(
          "Ú©Ø¯ Ø¬Ø¯ÛŒØ¯ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù‡Ù…Ø§Ù† Ú©Ø¯ÛŒ Ú©Ù‡ Ø¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ù‡Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯):",
          currentUserCode || ""
        );
        if (input === null) return;
        const trimmed = input.trim();
        if (!trimmed) {
          alert("Ú©Ø¯ Ù†Ø¨Ø§ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.");
          return;
        }
        setUserCode(trimmed);
        entries = await loadEntriesFromServer();
        renderTable();
        updateSummaryForSelectedDate();
        checkHydrationStatus();
      });

      // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯
      document
        .querySelectorAll("#entryModalOverlay .modal-grid button")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            const field = btn.getAttribute("data-field");
            if (!field) return;
            openFieldModal(field);
          });
        });

      document.getElementById("entryModalSaveBtn").addEventListener("click", () => {
        saveDraftEntry().catch(console.error);
      });

      document.getElementById("entryModalCancelBtn").addEventListener("click", () => {
        const ok = confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø¯ÙˆÙ† Ø°Ø®ÛŒØ±Ù‡ Ø§Ø² Ø§ÛŒÙ† Ù¾Ù†Ø¬Ø±Ù‡ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ");
        if (ok) closeEntryModal(true);
      });

      // Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ ÙÛŒÙ„Ø¯ â€“ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
      document.getElementById("fieldModalConfirmBtn").addEventListener("click", () => {
        applyFieldModalConfirm();
      });

      document.getElementById("fieldModalCancelBtn").addEventListener("click", () => {
        applyFieldModalCancel();
      });

      // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
      if (fieldModalOverlay) {
        fieldModalOverlay.addEventListener("click", (e) => {
          if (e.target === fieldModalOverlay) {
            closeFieldModal();
          }
        });
      }

      // Ø¨Ø³ØªÙ† Ù¾ÛŒØ§Ù… Ù…Ø§ÛŒØ¹Ø§Øª
      const closeHydrationBtn = document.getElementById("closeHydrationBtn");
      if (closeHydrationBtn) {
        closeHydrationBtn.addEventListener("click", () => {
          window._hydrationDismissed = true;
          const box = document.getElementById("hydrationMessage");
          if (box) box.style.display = "none";
        });
      }

      initApp().catch((e) => {
        console.error(e);
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ (ØªÙ†Ø¸ÛŒÙ…Ø§Øª Supabase Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯).");
      });
    });
  </script>
</body>
</html>