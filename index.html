<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>کنترل مایعات – نسخه Supabase</title>

<style>
    body {
        font-family: tahoma, sans-serif;
        background: #f5f5f5;
        padding: 20px;
        margin: 0;
    }

    .container {
        max-width: 900px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px #ccc;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 6px;
        text-align: center;
    }

    th {
        background: #eee;
    }

    .input-cell { background: #d2f4ff; }
    .output-cell { background: #F8B4DC; }
    .note-cell { background: #ecffef; }

    button {
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-primary { background: #007bff; color: white; }
    .btn-danger { background: #d9534f; color: white; }

    .modal-bg {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        display: none;
        align-items: center;
        justify-content: center;
    }

    .modal {
        background: white;
        padding: 20px;
        width: 320px;
        border-radius: 12px;
        text-align: center;
    }

    input, select {
        width: 90%;
        padding: 6px;
        margin: 5px 0;
    }
</style>
</head>

<body>

<div class="container">

    <h2>کنترل ثبت مایعات</h2>

    <!-- انتخاب تاریخ -->
    <label>تاریخ گزارش:</label>
    <input type="date" id="reportDate" />

    <button class="btn-primary" id="newRowBtn">ردیف جدید</button>

    <!-- جدول -->
    <table id="entriesTable">
        <thead>
            <tr>
                <th>نوع تزریق (cc)</th>
                <th>نوشیدنی (cc)</th>
                <th>نفرو راست</th>
                <th>نفرو چپ</th>
                <th>ایلوستومی</th>
                <th>کلستومی</th>
                <th>استفراغ</th>
                <th>توضیحات</th>
                <th>عملیات</th>
            </tr>
        </thead>
        <tbody id="entriesBody"></tbody>
    </table>

</div>

<!-- مودال ثبت ردیف جدید -->
<div class="modal-bg" id="entryModal">
    <div class="modal">
        <h3>ثبت ردیف جدید</h3>

        <input type="number" id="m_infusion" placeholder="تزریق (cc)">
        <input type="text" id="m_infusionType" placeholder="نوع تزریق">
        <input type="number" id="m_drink" placeholder="نوشیدنی (cc)">
        <input type="number" id="m_right" placeholder="نفرو راست">
        <input type="number" id="m_left" placeholder="نفرو چپ">
        <input type="number" id="m_ileo" placeholder="ایلوستومی">
        <input type="number" id="m_colo" placeholder="کلستومی">
        <input type="number" id="m_vomit" placeholder="استفراغ">
        <input type="text" id="m_note" placeholder="توضیحات">

        <br><br>
        <button class="btn-primary" onclick="saveNewRow()">ذخیره</button>
        <button class="btn-danger" onclick="closeModal()">انصراف</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
// ------------------ اتصال به Supabase ------------------
const supabaseUrl = "https://mmlvqmptvjeldxvkycrx.supabase.co";
const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tbHZxbXB0dmplbGR4dmt5Y3J4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTUwODUsImV4cCI6MjA3OTMzMTA4NX0.bU65ru6zNAryNQQgkxCAU2mA-zQiwZCuCkOIZek4HJo";

const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

// ------------------ بارگذاری داده ------------------
async function loadEntries() {
    const date = document.getElementById("reportDate").value;
    if (!date) return;

    const { data, error } = await supabaseClient
        .from("entries")
        .select("*")
        .eq("date", date)
        .order("id", { ascending: true });

    if (error) {
        alert("خطا در خواندن داده:\n" + error.message);
        return;
    }

    const body = document.getElementById("entriesBody");
    body.innerHTML = "";

    data.forEach(row => addRowToTable(row));
}

// ------------------ نمایش جدول ------------------
function addRowToTable(row) {
    const tr = document.createElement("tr");

    tr.innerHTML = `
        <td class="input-cell">${row.infusion_volume || ""}</td>
        <td class="input-cell">${row.oral_intake || ""}</td>
        <td class="output-cell">${row.nephro_right || ""}</td>
        <td class="output-cell">${row.nephro_left || ""}</td>
        <td class="output-cell">${row.ileostomy || ""}</td>
        <td class="output-cell">${row.colostomy || ""}</td>
        <td class="output-cell">${row.vomiting || ""}</td>
        <td class="note-cell">${row.notes || ""}</td>

        <td>
            <button class="btn-danger" onclick="deleteRow(${row.id})">حذف</button>
        </td>
    `;

    document.getElementById("entriesBody").appendChild(tr);
}

// ------------------ حذف ردیف ------------------
async function deleteRow(id) {
    if (!confirm("آیا از حذف این ردیف مطمئن هستید؟")) return;

    await supabaseClient.from("entries").delete().eq("id", id);

    loadEntries();
}

// ------------------ مودال ------------------
function openModal() {
    document.getElementById("entryModal").style.display = "flex";
}
function closeModal() {
    document.getElementById("entryModal").style.display = "none";
}

// ------------------ ذخیره ردیف جدید ------------------
async function saveNewRow() {
    const date = document.getElementById("reportDate").value;
    if (!date) return alert("تاریخ را انتخاب کنید");

    const data = {
        date,
        infusion_volume: document.getElementById("m_infusion").value,
        infusion_type: document.getElementById("m_infusionType").value,
        oral_intake: document.getElementById("m_drink").value,
        nephro_right: document.getElementById("m_right").value,
        nephro_left: document.getElementById("m_left").value,
        ileostomy: document.getElementById("m_ileo").value,
        colostomy: document.getElementById("m_colo").value,
        vomiting: document.getElementById("m_vomit").value,
        notes: document.getElementById("m_note").value
    };

    await supabaseClient.from("entries").insert([data]);
    closeModal();
    loadEntries();
}

// ------------------ رویدادها ------------------
document.getElementById("reportDate").addEventListener("change", loadEntries);
document.getElementById("newRowBtn").onclick = openModal;
</script>

</body>
</html>
