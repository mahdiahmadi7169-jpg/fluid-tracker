<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>کنترل مایعات - نسخه Supabase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Tahoma, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      margin-top: 0;
      text-align: center;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
    }
    button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
      font-size: 14px;
    }
    button.secondary { background: #757575; }
    button.danger { background: #d32f2f; }
    button:disabled { opacity: 0.5; cursor: default; }

    input[type="date"], input[type="time"], select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .summary-card {
      background: #ffffff;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 12px;
      font-family: Tahoma, monospace;
      font-size: 13px;
    }
    .summary-card pre {
      white-space: pre-wrap;
      margin: 0;
    }

    .layout {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-start;
    }
    .table-wrapper {
      flex: 1 1 100%;
      min-width: 280px;
      background: #ffffff;
      border-radius: 10px;
      padding: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      max-height: 60vh;
      overflow-y: auto;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 900px;
    }
    thead {
      position: sticky;
      top: 0;
      background: #eeeeee;
      z-index: 1;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 4px 6px;
      text-align: center;
    }
    th { font-weight: 600; }
    tr:nth-child(even) td { background: #fafafa; }
    tr.active-row td { outline: 2px solid #0288d1; }

    /* رنگ ستون‌ها */
    .input-header, .input-col { background-color: #d2f4ff; }   /* ورودی */
    .output-header, .output-col { background-color: #F8B4DC; } /* خروجی */
    .notes-header, .notes-col { background-color: #ecffef; }   /* توضیحات */

    .save-col button {
      width: 100%;
      padding: 4px 6px;
      font-size: 11px;
      border-radius: 4px;
      background: #00897b;
      color: #fff;
    }

    .chart-card {
      margin-top: 16px;
      background: #ffffff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .chart-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }

    /* مودال‌ها */
    .hidden { display: none; }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal {
      background: #ffffff;
      border-radius: 10px;
      padding: 16px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-size: 13px;
    }
    .modal h3 {
      margin-top: 0;
      margin-bottom: 8px;
      text-align: center;
    }
    .modal-datetime {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .modal-datetime span {
      font-size: 12px;
    }
    .modal-datetime button {
      font-size: 11px;
      padding: 4px 8px;
    }
    .modal-datetime-edit {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      justify-content: center;
    }
    .modal-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-bottom: 10px;
    }
    .modal-grid button {
      padding: 8px 6px;
      font-size: 11px;
      background: #eeeeee;
      color: #222;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    .modal.small {
      max-width: 360px;
    }
    .modal-field-body {
      margin: 10px 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .modal-field-body input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: Tahoma, sans-serif;
    }

    @media (max-width: 768px) {
      .layout { flex-direction: column; }
      .table-wrapper { max-height: 50vh; }
      .modal-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>کنترل مایعات (نسخه Supabase)</h1>

    <div class="top-bar">
      <span>کد کاربر:</span>
      <span id="userIdLabel" style="font-weight:bold;">...</span>
      <button id="changeUserBtn" class="secondary">تغییر کد</button>
    </div>

    <div class="top-bar">
      <button id="newRowBtn">جدید چی داری بگی</button>
      <span>تاریخ گزارش روزانه:</span>
      <input type="date" id="reportDate" />
      <button id="refreshSummaryBtn" class="secondary">همگام‌سازی و به‌روزرسانی</button>
    </div>

    <div class="summary-card">
      <pre id="summaryText">در حال بارگذاری...</pre>
      <div id="hydrationMessage"
           style="margin-top:8px;font-size:13px;font-weight:bold;display:none;align-items:center;justify-content:space-between;gap:8px;">
        <span id="hydrationText"></span>
        <button id="closeHydrationBtn" class="secondary" style="padding:2px 6px;font-size:11px;">×</button>
      </div>
    </div>

    <div class="layout">
      <div class="table-wrapper">
        <table id="entriesTable">
          <thead>
            <tr>
              <th>تاریخ</th>
              <th>ساعت</th>
              <th class="input-header">تزریق (cc)</th>
              <th>نوع تزریق</th>
              <th class="input-header">نوشیدنی (cc)</th>
              <th class="output-header">نفرو راست (cc)</th>
              <th class="output-header">نفرو چپ (cc)</th>
              <th class="output-header">ایلوستومی (cc)</th>
              <th class="output-header">کلستومی (cc)</th>
              <th class="output-header">استفراغ (cc)</th>
              <th class="notes-header">توضیحات</th>
              <th class="save-col">Save</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- مودال اصلی ورود ردیف جدید -->
    <div id="entryModalOverlay" class="modal-overlay hidden" style="display:none;">
      <div class="modal">
        <h3>ثبت ردیف جدید</h3>
        <div class="modal-datetime">
          <span>تاریخ: <span id="modalDateText"></span></span>
          <span>ساعت: <span id="modalTimeText"></span></span>
          <button id="editDateTimeBtn" class="secondary">ویرایش تاریخ و ساعت</button>
        </div>
        <div id="modalDateTimeEditors" class="modal-datetime-edit hidden">
          <input type="date" id="modalDateInput" />
          <input type="time" id="modalTimeInput" step="60" />
        </div>
        <div style="font-size:11px; margin-bottom:6px; text-align:center;">
          برای هر مورد، روی دکمه بزنید، مقدار را وارد کنید و تأیید/کنسل کنید.
        </div>
        <div class="modal-grid">
          <button type="button" data-field="infusion_volume">تزریق (cc)</button>
          <button type="button" data-field="oral_intake">نوشیدنی (cc)</button>
          <button type="button" data-field="nephro_right">نفرو راست (cc)</button>
          <button type="button" data-field="nephro_left">نفرو چپ (cc)</button>
          <button type="button" data-field="ileostomy">ایلوستومی (cc)</button>
          <button type="button" data-field="colostomy">کلستومی (cc)</button>
          <button type="button" data-field="vomiting">استفراغ (cc)</button>
          <button type="button" data-field="notes">توضیحات</button>
        </div>
        <div class="modal-footer">
          <button id="entryModalSaveBtn">ذخیره</button>
          <button id="entryModalCancelBtn" class="secondary">کنسل</button>
        </div>
      </div>
    </div>

    <!-- مودال ویرایش یک فیلد -->
    <div id="fieldModalOverlay" class="modal-overlay hidden" style="display:none;">
      <div class="modal small">
        <h3 id="fieldModalTitle">ویرایش</h3>
        <div class="modal-field-body">
          <input id="fieldModalInput" type="number" dir="ltr" />
        </div>
        <div class="modal-footer">
          <button id="fieldModalConfirmBtn">تأیید</button>
          <button id="fieldModalCancelBtn" class="secondary">انصراف</button>
        </div>
      </div>
    </div>

    <!-- نمودار ترند در انتهای صفحه -->
    <div class="chart-card">
      <div class="chart-controls">
        <span>بازه تاریخ نمودار:</span>
        <label>از
          <input type="date" id="chartFromDate" />
        </label>
        <label>تا
          <input type="date" id="chartToDate" />
        </label>
        <span>ستون:</span>
        <select id="chartMetric">
          <option value="infusion_volume">تزریق (cc)</option>
          <option value="oral_intake">نوشیدنی (cc)</option>
          <option value="nephro_right">نفروستومی راست (cc)</option>
          <option value="nephro_left">نفروستومی چپ (cc)</option>
          <option value="ileostomy">ایلوستومی (cc)</option>
          <option value="colostomy">کلستومی (cc)</option>
          <option value="vomiting">استفراغ (cc)</option>
        </select>
        <button id="drawChartBtn">رسم نمودار</button>
      </div>
      <canvas id="trendChart" height="120"></canvas>
    </div>
  </div>

  <script>
    // === اتصال به Supabase ===
    const supabaseUrl = "https://mmlvqmptvjeldxvkycrx.supabase.co";
    const supabaseAnonKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tbHZxbXB0dmplbGR4dmt5Y3J4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTUwODUsImV4cCI6MjA3OTMzMTA4NX0.bU65ru6zNAryNQQgkxCAU2mA-zQiwZCuCkOIZek4HJo";

    const supa = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    const STORAGE_USER_KEY = "fluid_supabase_user_code_v1";
    let currentUserCode = null;
    let entries = [];
    let currentEditingId = null;
    let trendChartInstance = null;
    let draftEntry = null;
    let currentFieldKey = null;

    const fieldTitles = {
      infusion_volume: "تزریق (cc)",
      oral_intake: "نوشیدنی (cc)",
      nephro_right: "نفرو راست (cc)",
      nephro_left: "نفرو چپ (cc)",
      ileostomy: "ایلوستومی (cc)",
      colostomy: "کلستومی (cc)",
      vomiting: "استفراغ (cc)",
      notes: "توضیحات",
      infusion_type: "نوع تزریق"
    };

    const metricLabels = {
      infusion_volume: "تزریق (cc)",
      oral_intake: "نوشیدنی (cc)",
      nephro_right: "نفروستومی راست (cc)",
      nephro_left: "نفروستومی چپ (cc)",
      ileostomy: "ایلوستومی (cc)",
      colostomy: "کلستومی (cc)",
      vomiting: "استفراغ (cc)",
    };

    function formatDateInput(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatTime(d) {
      const h = String(d.getHours()).padStart(2, "0");
      const m = String(d.getMinutes()).padStart(2, "0");
      return `${h}:${m}`;
    }

    function deriveTimestamp(dateStr, timeStr) {
      if (!dateStr) return null;
      const [y, m, d] = dateStr.split("-").map(Number);
      if (!y || !m || !d) return null;
      let hh = 0, mm = 0;
      if (timeStr && timeStr.includes(":")) {
        [hh, mm] = timeStr.split(":").map(Number);
      }
      const dt = new Date(y, m - 1, d, hh || 0, mm || 0, 0, 0);
      return dt.getTime();
    }

    // --- مدیریت کد کاربر ---
    function askUserCode() {
      let code = null;
      while (!code) {
        const input = prompt(
          "یک کد اختصاصی برای خودتان وارد کنید (مثلاً: farnaz-1404). این کد را روی تمام دستگاه‌ها یکسان وارد کنید:",
          ""
        );
        if (input === null) {
          alert("بدون کد کاربر، برنامه نمی‌تواند به دیتابیس مشترک وصل شود.");
          continue;
        }
        const trimmed = input.trim();
        if (!trimmed) {
          alert("کد نباید خالی باشد.");
          continue;
        }
        code = trimmed;
      }
      return code;
    }

    function setUserCode(code) {
      currentUserCode = code;
      localStorage.setItem(STORAGE_USER_KEY, code);
      document.getElementById("userIdLabel").textContent = code;
    }

    function getOrInitUserCode() {
      let code = localStorage.getItem(STORAGE_USER_KEY);
      if (!code) code = askUserCode();
      setUserCode(code);
    }

    // --- ارتباط با Supabase ---
    async function loadEntriesFromServer() {
      if (!currentUserCode) return [];
      const { data, error } = await supa
        .from("entries")
        .select("*")
        .eq("user_code", currentUserCode)
        .order("timestamp", { ascending: true });

      if (error) {
        console.error(error);
        alert("خطا در خواندن داده از Supabase (اینترنت یا تنظیمات پروژه را چک کنید).");
        return [];
      }
      return data || [];
    }

    async function saveEntryToServer(entry) {
      if (!currentUserCode) {
        alert("کد کاربر تنظیم نشده است.");
        return;
      }
      const { error } = await supa
        .from("entries")
        .upsert(entry, { onConflict: "id" });

      if (error) {
        console.error(error);
        alert("خطا در ذخیره روی Supabase.");
      }
    }

    // --- جدول اصلی ---
    function renderTable() {
      const tbody = document.querySelector("#entriesTable tbody");
      tbody.innerHTML = "";

      const sorted = [...entries].sort(
        (a, b) => (a.timestamp || 0) - (b.timestamp || 0)
      );
      for (const e of sorted) {
        const tr = document.createElement("tr");
        tr.dataset.id = String(e.id);

        function addCell(field, value) {
          const td = document.createElement("td");
          td.dataset.field = field;

          if (["infusion_volume", "oral_intake"].includes(field)) {
            td.classList.add("input-col");
          }
          if (
            ["nephro_right", "nephro_left", "ileostomy", "colostomy", "vomiting"]
              .includes(field)
          ) {
            td.classList.add("output-col");
          }
          if (field === "notes") {
            td.classList.add("notes-col");
          }
          if (field === "save") {
            td.classList.add("save-col");
            const btn = document.createElement("button");
            btn.textContent = "Save";
            td.appendChild(btn);
          } else {
            td.textContent =
              value !== null && value !== undefined && value !== ""
                ? value
                : "";
          }
          tr.appendChild(td);
        }

        addCell("date", e.date || "");
        addCell("time", e.time || "");
        addCell("infusion_volume", e.infusion_volume ?? "");
        addCell("infusion_type", e.infusion_type ?? "");
        addCell("oral_intake", e.oral_intake ?? "");
        addCell("nephro_right", e.nephro_right ?? "");
        addCell("nephro_left", e.nephro_left ?? "");
        addCell("ileostomy", e.ileostomy ?? "");
        addCell("colostomy", e.colostomy ?? "");
        addCell("vomiting", e.vomiting ?? "");
        addCell("notes", e.notes ?? "");
        addCell("save", "");

        tbody.appendChild(tr);
      }
      highlightActiveRow();
    }

    function highlightActiveRow() {
      const rows = document.querySelectorAll("#entriesTable tbody tr");
      rows.forEach((tr) => {
        const id = Number(tr.dataset.id);
        if (currentEditingId && id === currentEditingId) {
          tr.classList.add("active-row");
        } else {
          tr.classList.remove("active-row");
        }
      });
    }

    async function editField(entryId, field) {
      const entry = entries.find((e) => e.id === entryId);
      if (!entry) return;

      if (field === "date") {
        const val = prompt(
          "تاریخ (فرمت YYYY-MM-DD، مثلا 2025-11-22):",
          entry.date || ""
        );
        if (val === null) return;
        entry.date = val.trim();
      } else if (field === "time") {
        const val = prompt(
          "ساعت (فرمت HH:MM، مثلا 14:30):",
          entry.time || ""
        );
        if (val === null) return;
        entry.time = val.trim();
      } else if (field === "infusion_type" || field === "notes") {
        const val = prompt(
          field === "infusion_type" ? "نوع تزریق:" : "توضیحات:",
          entry[field] || ""
        );
        if (val === null) return;
        entry[field] = val.trim() || null;
      } else if (
        ["infusion_volume", "oral_intake", "nephro_right", "nephro_left",
         "ileostomy", "colostomy", "vomiting"].includes(field)
      ) {
        const oldVal = entry[field] != null ? String(entry[field]) : "";
        const val = prompt("مقدار به cc (فقط عدد، خالی = حذف):", oldVal);
        if (val === null) return;
        const t = val.trim();
        if (t === "") {
          entry[field] = null;
        } else {
          const num = Number(t);
          if (Number.isNaN(num)) {
            alert("مقدار وارد شده عدد نیست.");
            return;
          }
          entry[field] = num;
        }
      } else {
        return;
      }

      const ts = deriveTimestamp(entry.date, entry.time);
      if (ts) entry.timestamp = ts;

      renderTable();
      updateSummaryForSelectedDate();
      checkHydrationStatus();
      await saveEntryToServer(entry);
    }

    // --- خلاصه روزانه ---
    function calculateSummaryForDate(dateStr) {
      const dayEntries = entries.filter((e) => e.date === dateStr);

      const sum = (field) =>
        dayEntries.reduce((acc, e) => acc + (Number(e[field]) || 0), 0);

      const res = {
        infusionTotal: sum("infusion_volume"),
        oralTotal: sum("oral_intake"),
        nephroRightTotal: sum("nephro_right"),
        nephroLeftTotal: sum("nephro_left"),
        ileostomyTotal: sum("ileostomy"),
        colostomyTotal: sum("colostomy"),
        vomitingTotal: sum("vomiting"),
      };
      res.inputTotal = res.infusionTotal + res.oralTotal;
      res.outputTotal =
        res.nephroRightTotal +
        res.nephroLeftTotal +
        res.ileostomyTotal +
        res.colostomyTotal +
        res.vomitingTotal;
      res.netBalance = res.inputTotal - res.outputTotal;
      return res;
    }

    function buildSummaryText(summary, dateStr) {
      return [
        `تاریخ گزارش: ${dateStr}`,
        "",
        "ورودی‌ها:",
        `- تزریق: ${summary.infusionTotal} cc`,
        `- نوشیدنی: ${summary.oralTotal} cc`,
        `مجموع ورودی: ${summary.inputTotal} cc`,
        "",
        "خروجی‌ها:",
        `- نفروستومی راست: ${summary.nephroRightTotal} cc`,
        `- نفروستومی چپ: ${summary.nephroLeftTotal} cc`,
        `- ایلوستومی: ${summary.ileostomyTotal} cc`,
        `- کلستومی: ${summary.colostomyTotal} cc`,
        `- استفراغ: ${summary.vomitingTotal} cc`,
        `مجموع خروجی: ${summary.outputTotal} cc`,
        "",
        `تراز مایع (ورودی - خروجی): ${summary.netBalance} cc`,
      ].join("\n");
    }

    function updateSummaryForSelectedDate() {
      const dateInput = document.getElementById("reportDate");
      const dateStr = dateInput.value;
      const summaryEl = document.getElementById("summaryText");
      if (!dateStr) {
        summaryEl.textContent = "لطفاً تاریخ گزارش را انتخاب کنید.";
        return;
      }
      const summary = calculateSummaryForDate(dateStr);
      summaryEl.textContent = buildSummaryText(summary, dateStr);
    }

    // --- پیام وضعیت مایعات ---
    function checkHydrationStatus() {
      const box = document.getElementById("hydrationMessage");
      const textEl = document.getElementById("hydrationText");
      if (!box || !textEl) return;

      if (window._hydrationDismissed) {
        box.style.display = "none";
        return;
      }

      if (!entries || entries.length === 0) {
        box.style.display = "none";
        return;
      }

      const today = new Date();
      const todayStr = formatDateInput(today);
      const todaySummary = calculateSummaryForDate(todayStr);
      const todayNet = todaySummary.netBalance;

      const messages = [];

      if (todayNet < 0) {
        messages.push("بچه مایعات بخور ، عقب هستیا! 🥤");
      } else if (todayNet > 0) {
        messages.push("آفرییییین 👏 مایعات جلو هستی!");
      }

      let negativeDays = 0;
      for (let i = 1; i <= 3; i++) {
        const d = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
        const dStr = formatDateInput(d);
        const s = calculateSummaryForDate(dStr);
        if (s.netBalance < 0) negativeDays++;
      }

      if (negativeDays > 0) {
        messages.push(
          `تو سه روز قبل مایعات عقب بودیا 😬 (در ${negativeDays} روز از ۳ روز گذشته تراز منفی بوده)`
        );
      }

      if (messages.length === 0) {
        box.style.display = "none";
      } else {
        textEl.textContent = messages.join("  |  ");
        box.style.display = "flex";
      }
    }

    // --- نمودار ترند ---
    async function drawTrendChart() {
      if (!currentUserCode) {
        alert("اول کد کاربر را تنظیم کنید.");
        return;
      }
      const fromDate = document.getElementById("chartFromDate").value;
      const toDate = document.getElementById("chartToDate").value;
      const metric = document.getElementById("chartMetric").value;

      if (!fromDate || !toDate) {
        alert("لطفاً هر دو تاریخ «از» و «تا» را وارد کنید.");
        return;
      }
      if (fromDate > toDate) {
        alert("تاریخ شروع نباید بعد از تاریخ پایان باشد.");
        return;
      }

      entries = await loadEntriesFromServer();

      const filtered = entries.filter(
        (e) => e.date && e.date >= fromDate && e.date <= toDate
      );

      if (filtered.length === 0) {
        alert("در این بازه‌ی زمانی داده‌ای ثبت نشده است.");
        return;
      }

      const map = new Map(); // date -> sum
      for (const e of filtered) {
        const d = e.date;
        const v = Number(e[metric]) || 0;
        map.set(d, (map.get(d) || 0) + v);
      }

      const dates = Array.from(map.keys()).sort();
      const data = dates.map((d) => map.get(d));

      const ctx = document.getElementById("trendChart").getContext("2d");
      if (trendChartInstance) trendChartInstance.destroy();

      trendChartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: dates,
          datasets: [
            {
              label: metricLabels[metric] || metric,
              data: data,
              tension: 0.3,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: (context) => `${context.parsed.y} cc`,
              },
            },
          },
          scales: {
            x: { title: { display: true, text: "تاریخ" } },
            y: {
              title: { display: true, text: "مقدار (cc)" },
              beginAtZero: true,
            },
          },
        },
      });
    }

    // --- مودال ردیف جدید ---
    const entryModal = document.getElementById("entryModalOverlay");
    const modalDateText = document.getElementById("modalDateText");
    const modalTimeText = document.getElementById("modalTimeText");
    const modalDateInput = document.getElementById("modalDateInput");
    const modalTimeInput = document.getElementById("modalTimeInput");

    function refreshModalFieldButtons() {
      document
        .querySelectorAll("#entryModalOverlay .modal-grid button")
        .forEach((btn) => {
          const field = btn.getAttribute("data-field");
          const base = fieldTitles[field] || field;
          const v = draftEntry ? draftEntry[field] : null;
          btn.textContent =
            v !== null && v !== undefined && v !== "" ? `${base} : ${v}` : base;
        });
    }

    function openEntryModal() {
      if (!currentUserCode) {
        alert("اول کد کاربر را تنظیم کنید.");
        return;
      }
      const now = new Date();
      const dateStr = formatDateInput(now);
      const timeStr = formatTime(now);

      draftEntry = {
        id: Date.now(),
        user_code: currentUserCode,
        timestamp: now.getTime(),
        date: dateStr,
        time: timeStr,
        infusion_volume: null,
        infusion_type: null,
        oral_intake: null,
        nephro_right: null,
        nephro_left: null,
        ileostomy: null,
        colostomy: null,
        vomiting: null,
        notes: null,
      };

      modalDateText.textContent = draftEntry.date;
      modalTimeText.textContent = draftEntry.time;
      modalDateInput.value = draftEntry.date;
      modalTimeInput.value = draftEntry.time;
      document.getElementById("modalDateTimeEditors").classList.add("hidden");

      refreshModalFieldButtons();
      entryModal.classList.remove("hidden");
      entryModal.style.display = "flex";
    }

    function closeEntryModal(discard) {
      if (discard) draftEntry = null;
      entryModal.classList.add("hidden");
      entryModal.style.display = "none";
    }

    // --- مودال ویرایش فیلد ---
    const fieldModalOverlay = document.getElementById("fieldModalOverlay");
    const fieldModalTitle = document.getElementById("fieldModalTitle");
    const fieldModalInput = document.getElementById("fieldModalInput");

    function openFieldModal(fieldKey) {
      if (!draftEntry) return;
      currentFieldKey = fieldKey;

      fieldModalTitle.textContent = fieldTitles[fieldKey] || "ویرایش";

      if (fieldKey === "notes" || fieldKey === "infusion_type") {
        fieldModalInput.type = "text";
        fieldModalInput.dir = "rtl";
      } else {
        fieldModalInput.type = "number";
        fieldModalInput.dir = "ltr";
      }

      const curVal = draftEntry[fieldKey];
      fieldModalInput.value =
        curVal !== null && curVal !== undefined ? curVal : "";
      fieldModalOverlay.classList.remove("hidden");
      fieldModalOverlay.style.display = "flex";
      fieldModalInput.focus();
    }

    function closeFieldModal() {
      fieldModalOverlay.classList.add("hidden");
      fieldModalOverlay.style.display = "none";
      currentFieldKey = null;
    }

    function applyFieldModalConfirm() {
      if (!draftEntry || !currentFieldKey) {
        closeFieldModal();
        return;
      }
      const val = fieldModalInput.value.trim();

      if (currentFieldKey === "notes" || currentFieldKey === "infusion_type") {
        draftEntry[currentFieldKey] = val || null;
      } else {
        if (val === "") {
          draftEntry[currentFieldKey] = null;
        } else {
          const num = Number(val);
          if (Number.isNaN(num)) {
            alert("لطفاً مقدار عددی وارد کنید.");
            return;
          }
          draftEntry[currentFieldKey] = num;
        }
      }

      refreshModalFieldButtons();
      const justField = currentFieldKey;
      closeFieldModal();

      if (justField === "infusion_volume" && draftEntry.infusion_volume != null) {
        openFieldModal("infusion_type");
      }
    }

    function applyFieldModalCancel() {
      closeFieldModal();
      try {
        if (draftEntry && currentFieldKey) {
          draftEntry[currentFieldKey] = null;
        }
        refreshModalFieldButtons();
      } catch (err) {
        console.error("Modal cancel error:", err);
      }
    }

    async function saveDraftEntry() {
      if (!draftEntry) return;

      if (modalDateInput.value) draftEntry.date = modalDateInput.value;
      if (modalTimeInput.value) draftEntry.time = modalTimeInput.value;

      const ts = deriveTimestamp(draftEntry.date, draftEntry.time);
      draftEntry.timestamp = ts || Date.now();

      entries.push(draftEntry);
      await saveEntryToServer(draftEntry);
      renderTable();
      updateSummaryForSelectedDate();
      checkHydrationStatus();

      draftEntry = null;
      closeEntryModal(false);
    }

    // --- init ---
    async function initApp() {
      // اطمینان از بسته بودن مودال‌ها در شروع
      entryModal.classList.add("hidden");
      entryModal.style.display = "none";
      fieldModalOverlay.classList.add("hidden");
      fieldModalOverlay.style.display = "none";
      draftEntry = null;
      currentFieldKey = null;

      const today = new Date();
      const todayStr = formatDateInput(today);
      const reportDateInput = document.getElementById("reportDate");
      reportDateInput.value = todayStr;

      const chartFromInput = document.getElementById("chartFromDate");
      const chartToInput = document.getElementById("chartToDate");
      const weekAgo = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000);
      chartToInput.value = todayStr;
      chartFromInput.value = formatDateInput(weekAgo);

      getOrInitUserCode();

      entries = await loadEntriesFromServer();
      renderTable();
      updateSummaryForSelectedDate();
      checkHydrationStatus();
    }

    document.addEventListener("DOMContentLoaded", () => {
      // مطمئن شو در لود اولیه مودال‌ها بسته‌اند
      entryModal.classList.add("hidden");
      entryModal.style.display = "none";
      fieldModalOverlay.classList.add("hidden");
      fieldModalOverlay.style.display = "none";

      document.getElementById("newRowBtn").addEventListener("click", () => {
        openEntryModal();
      });

      document.getElementById("refreshSummaryBtn").addEventListener("click", async () => {
        entries = await loadEntriesFromServer();
        renderTable();
        updateSummaryForSelectedDate();
        checkHydrationStatus();
      });

      document.getElementById("drawChartBtn").addEventListener("click", () => {
        drawTrendChart().catch(console.error);
      });

      // جدول – کلیک برای ویرایش و Save
      const tbody = document.querySelector("#entriesTable tbody");
      tbody.addEventListener("click", (e) => {
        const td = e.target.closest("td");
        if (!td) return;
        const tr = td.parentElement;
        const id = Number(tr.dataset.id);
        if (!id) return;

        const field = td.dataset.field;

        if (field === "save") {
          currentEditingId = null;
          highlightActiveRow();
          return;
        }

        currentEditingId = id;
        highlightActiveRow();
        if (field) {
          editField(id, field);
        }
      });

      document.getElementById("changeUserBtn").addEventListener("click", async () => {
        const input = prompt(
          "کد جدید کاربر را وارد کنید (همان کدی که در دستگاه‌های دیگر هم استفاده می‌کنید):",
          currentUserCode || ""
        );
        if (input === null) return;
        const trimmed = input.trim();
        if (!trimmed) {
          alert("کد نباید خالی باشد.");
          return;
        }
        setUserCode(trimmed);
        entries = await loadEntriesFromServer();
        renderTable();
        updateSummaryForSelectedDate();
        checkHydrationStatus();
      });

      // مودال ردیف جدید
      document.getElementById("editDateTimeBtn").addEventListener("click", () => {
        const box = document.getElementById("modalDateTimeEditors");
        box.classList.toggle("hidden");
      });

      document
        .querySelectorAll("#entryModalOverlay .modal-grid button")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            const field = btn.getAttribute("data-field");
            if (!field) return;
            openFieldModal(field);
          });
        });

      document.getElementById("entryModalSaveBtn").addEventListener("click", () => {
        saveDraftEntry().catch(console.error);
      });

      document.getElementById("entryModalCancelBtn").addEventListener("click", () => {
        const ok = confirm("آیا مطمئن هستید که می‌خواهید بدون ذخیره از این پنجره خارج شوید؟");
        if (ok) closeEntryModal(true);
      });

      // مودال ویرایش فیلد – دکمه‌ها
      document.getElementById("fieldModalConfirmBtn").addEventListener("click", () => {
        applyFieldModalConfirm();
      });

      document.getElementById("fieldModalCancelBtn").addEventListener("click", () => {
        applyFieldModalCancel();
      });

      // بستن مودال ویرایش با کلیک روی پس‌زمینه
      if (fieldModalOverlay) {
        fieldModalOverlay.addEventListener("click", (e) => {
          if (e.target === fieldModalOverlay) {
            closeFieldModal();
          }
        });
      }

      // بستن پیام مایعات
      const closeHydrationBtn = document.getElementById("closeHydrationBtn");
      if (closeHydrationBtn) {
        closeHydrationBtn.addEventListener("click", () => {
          window._hydrationDismissed = true;
          const box = document.getElementById("hydrationMessage");
          if (box) box.style.display = "none";
        });
      }

      initApp().catch((e) => {
        console.error(e);
        alert("خطا در راه‌اندازی برنامه (تنظیمات Supabase را چک کنید).");
      });
    });
  </script>
</body>
</html>
