currentUserCode || ""
        );
        if (input === null) return;
        const trimmed = input.trim();
        if (!trimmed) {
          alert("کد نباید خالی باشد.");
          return;
        }
        setUserCode(trimmed);
        entries = await loadEntriesFromServer();
        renderTable();
        updateSummaryForSelectedDate();
        checkHydrationStatus();
      });

      // مودال ردیف جدید
      document.getElementById("editDateTimeBtn").addEventListener("click", () => {
        const box = document.getElementById("modalDateTimeEditors");
        box.classList.toggle("hidden");
      });

      document
        .querySelectorAll("#entryModalOverlay .modal-grid button")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            const field = btn.getAttribute("data-field");
            if (!field) return;
            openFieldModal(field);
          });
        });

      document.getElementById("entryModalSaveBtn").addEventListener("click", () => {
        saveDraftEntry().catch(console.error);
      });

      document.getElementById("entryModalCancelBtn").addEventListener("click", () => {
        const ok = confirm("آیا مطمئن هستید که می‌خواهید بدون ذخیره از این پنجره خارج شوید؟");
        if (ok) closeEntryModal(true);
      });

      // مودال ویرایش فیلد – دکمه‌ها
      document.getElementById("fieldModalConfirmBtn").addEventListener("click", () => {
        applyFieldModalConfirm();
      });

      document.getElementById("fieldModalCancelBtn").addEventListener("click", () => {
        applyFieldModalCancel();
      });

      // بستن مودال ویرایش با کلیک روی پس‌زمینه
      if (fieldModalOverlay) {
        fieldModalOverlay.addEventListener("click", (e) => {
          if (e.target === fieldModalOverlay) {
            closeFieldModal();
          }
        });
      }

      // بستن پیام مایعات
      const closeHydrationBtn = document.getElementById("closeHydrationBtn");
      if (closeHydrationBtn) {
        closeHydrationBtn.addEventListener("click", () => {
          window._hydrationDismissed = true;
          const box = document.getElementById("hydrationMessage");
          if (box) box.style.display = "none";
        });
      }

      initApp().catch((e) => {
        console.error(e);
        alert("خطا در راه‌اندازی برنامه (تنظیمات Supabase را چک کنید).");
      });
    });
  </script>
</body>
</html>